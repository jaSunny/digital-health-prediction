SET SCHEMA TUKGRP1;
--prepare input training data table type--
DROP TYPE PAL_LOGISTICR_DATA_T;
CREATE TYPE PAL_LOGISTICR_DATA_T AS TABLE (
  --"ID" integer,
  --"UID" integer,
"FEATURE_GENDER" integer,
--"FEATURE_BIRTH_DATE" integer,
"FEATURE_BIRTH_YEAR" integer,
"FEATURE_AGE" integer,
"FEATURE_HEIGHT" integer,
"FEATURE_ZIP" integer,
"FEATURE_SMOKING_PACKS_A_DAY" integer,
"FEATURE_ACTIVITY_LEVEL" integer,
"FEATURE_BLOOD_TYPE" integer,
"FEATURE_AVG_SLEEP_TIME" integer,
"ROUND_AVG_SLEEP_TIME" integer,
"FEATURE_COMMUTING_DISTANCE" integer,
"FEATURE_DRINKS_ALCOHOL" integer,
"FEATURE_BMI" integer,
"FEATURE_SLEEP_BY_AGE" integer,
"FEATURE_ACTIVITY_LVL_COMMUTING_DIS_BY_AGE" integer,
"FEATURE_BMI_SMOKING_BY_AGE" integer,
"FEATURE_COMMUTING_DRUNK_AGE" integer,
--"FEATURE_SLEEP_POS_OFFSET_BY_AGE" integer,
"FEATURE_SLEEP_NEG_OFFSET_BY_AGE" integer,
"FEATURE_SLEEP_OFFSET_BY_AGE_FROM_MEAN" integer,
--"FEATURE_LN_ACTIVITY_SLEEP_BMI" integer,
--"FEATURE_LN_ACTIVITY_SLEEP" integer,
"SICK"  integer
);
--prepare result table type--
DROP TYPE PAL_LOGISTICR_RESULT_T;
CREATE TYPE PAL_LOGISTICR_RESULT_T AS TABLE("Coefficient" NVARCHAR(255),"CoefficientValue" DOUBLE,"ZSCORE" DOUBLE, "Pr(>|Z|)" DOUBLE);
--prepare argument table type--
DROP TYPE PAL_CONTROL_T;
CREATE TYPE PAL_CONTROL_T AS TABLE("NAME" VARCHAR(100), "INTARGS" INTEGER, "DOUBLEARGS" DOUBLE, "STRINGARGS" VARCHAR(100));
DROP TYPE PAL_LOGISTICR_STAT_T;
CREATE TYPE PAL_LOGISTICR_STAT_T AS TABLE( "STATISTICS" VARCHAR(100), "VALUE" DOUBLE);
DROP TYPE PAL_LOGISTICR_PMMLMODEL_T;
CREATE TYPE PAL_LOGISTICR_PMMLMODEL_T AS TABLE( "ID" INTEGER, "PMMLMODEL" VARCHAR(5000));
DROP table PAL_LOGISTICR_PDATA_TBL;
CREATE column table PAL_LOGISTICR_PDATA_TBL("POSITION" INT, "SCHEMA_NAME" NVARCHAR(256), "TYPE_NAME" NVARCHAR(256), "PARAMETER_TYPE" VARCHAR(7));
INSERT INTO PAL_LOGISTICR_PDATA_TBL VALUES (1,'TUKGRP1', 'PAL_LOGISTICR_DATA_T','IN');
INSERT INTO PAL_LOGISTICR_PDATA_TBL VALUES (2,'TUKGRP1', 'PAL_CONTROL_T','IN');
INSERT INTO PAL_LOGISTICR_PDATA_TBL VALUES (3,'TUKGRP1', 'PAL_LOGISTICR_RESULT_T','OUT');
INSERT INTO PAL_LOGISTICR_PDATA_TBL VALUES (4,'TUKGRP1', 'PAL_LOGISTICR_STAT_T','OUT');
INSERT INTO PAL_LOGISTICR_PDATA_TBL VALUES (5,'TUKGRP1', 'PAL_LOGISTICR_PMMLMODEL_T','OUT');
CALL SYS.AFLLANG_WRAPPER_PROCEDURE_DROP('TUKGRP1', 'PAL_LOGISTICR_PROC');
CALL SYS.AFLLANG_WRAPPER_PROCEDURE_CREATE('AFLPAL','LOGISTICREGRESSION', 'TUKGRP1', 'PAL_LOGISTICR_PROC',PAL_LOGISTICR_PDATA_TBL);
DROP TABLE PAL_LOGISTICR_DATA_TBL;
CREATE COLUMN TABLE PAL_LOGISTICR_DATA_TBL  LIKE PAL_LOGISTICR_DATA_T;
INSERT INTO PAL_LOGISTICR_DATA_TBL (SELECT
"FEATURE_GENDER",
--"FEATURE_BIRTH_DATE",
"FEATURE_BIRTH_YEAR",
"FEATURE_AGE",
"FEATURE_HEIGHT",
"FEATURE_ZIP",
"FEATURE_SMOKING_PACKS_A_DAY",
"FEATURE_ACTIVITY_LEVEL",
"FEATURE_BLOOD_TYPE",
"FEATURE_AVG_SLEEP_TIME",
"ROUND_AVG_SLEEP_TIME",
"FEATURE_COMMUTING_DISTANCE",
"FEATURE_DRINKS_ALCOHOL",
"FEATURE_BMI",
"FEATURE_SLEEP_BY_AGE",
"FEATURE_ACTIVITY_LVL_COMMUTING_DIS_BY_AGE",
"FEATURE_BMI_SMOKING_BY_AGE",
"FEATURE_COMMUTING_DRUNK_AGE",
--"FEATURE_SLEEP_POS_OFFSET_BY_AGE",
"FEATURE_SLEEP_NEG_OFFSET_BY_AGE",
"FEATURE_SLEEP_OFFSET_BY_AGE_FROM_MEAN",
--"FEATURE_LN_ACTIVITY_SLEEP_BMI",
--"FEATURE_LN_ACTIVITY_SLEEP",
"SICK"
   FROM TRAINING_FEATURES_CLASSIFIED);
DROP TABLE #PAL_CONTROL_TBL;
CREATE LOCAL TEMPORARY COLUMN TABLE #PAL_CONTROL_TBL ("NAME" VARCHAR(100), "INTARGS" INTEGER, "DOUBLEARGS" DOUBLE, "STRINGARGS" VARCHAR(100));
INSERT INTO #PAL_CONTROL_TBL VALUES ('METHOD', 0, null, null);
INSERT INTO #PAL_CONTROL_TBL VALUES ('EXIT_THRESHOLD',null,0.001,null);
INSERT INTO #PAL_CONTROL_TBL VALUES ('THREAD_NUMBER',200,null,null);
INSERT INTO #PAL_CONTROL_TBL VALUES ('MAX_ITERATION',1000,null,null);
--INSERT INTO #PAL_CONTROL_TBL VALUES ('CATEGORY_COL', 0, null, null);
INSERT INTO #PAL_CONTROL_TBL VALUES ('STAT_INF', 1, null, null);
INSERT INTO #PAL_CONTROL_TBL VALUES ('PMML_EXPORT', 2, null, null);
DROP TABLE PAL_LOGISTICR_RESULTS_TBL;
CREATE COLUMN TABLE PAL_LOGISTICR_RESULTS_TBL LIKE PAL_LOGISTICR_RESULT_T;
DROP TABLE PAL_LOGISTICR_STAT_TBL;
CREATE COLUMN TABLE PAL_LOGISTICR_STAT_TBL LIKE PAL_LOGISTICR_STAT_T;
DROP TABLE PAL_LOGISTICR_PMMLMODEL_TBL;
CREATE COLUMN TABLE PAL_LOGISTICR_PMMLMODEL_TBL LIKE PAL_LOGISTICR_PMMLMODEL_T;
CALL TUKGRP1.PAL_LOGISTICR_PROC(PAL_LOGISTICR_DATA_TBL, "#PAL_CONTROL_TBL", PAL_LOGISTICR_RESULTS_TBL, PAL_LOGISTICR_STAT_TBL, PAL_LOGISTICR_PMMLMODEL_TBL) WITH OVERVIEW;
SELECT * FROM PAL_LOGISTICR_RESULTS_TBL;
SELECT * FROM PAL_LOGISTICR_STAT_TBL;
SELECT * FROM PAL_LOGISTICR_PMMLMODEL_TBL;
